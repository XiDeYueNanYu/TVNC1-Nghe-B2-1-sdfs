<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Thêm viewport để tối ưu hóa di động -->
    <title>越南语听力练习</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            margin: 0; 
            padding-bottom: 300px; /* Mặc định cho màn hình lớn */
            background-color: #f7fbf3; /*f7fbf3  3f4040*/
        }
        #gameContainer {
            display: block;
            min-height: calc(100vh - 150px); /* Đảm bảo nội dung chiếm đủ chiều cao màn hình */
        }
        #infoBox { 
            width: 95%; 
            max-width: 700px;
            min-height: 100px; 
            margin: 0 auto; 
            border: 2px solid #91b66f; /*041b31 1f4263*/
            background: #85ae5f; /*ecf2e4 fefefc*/
            color: #ffffff; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(40px, 5vw, 60px);
            font-weight: bold;
        }
        #contactBox { 
            width: 90%; 
            max-width: 700px;
            min-height: 25px; 
            margin: 0px auto; 
            border: 2px solid #91b66f; 
            background: #85ae5f; 
            color: #f1c232; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px); 
            font-weight: bold;
        }
        #instructionBox { 
            width: 90%; 
            max-width: 700px;
            min-height: 25px; 
            margin: 0px auto; 
            border: 2px solid #91b66f; 
            background: #85ae5f; 
            color: #f7e19c; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px); 
            font-weight: bold;
        }
        #controls { 
            position: fixed; /* Cố định ở cuối màn hình */
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 800px; /* Giới hạn chiều rộng tối đa */
            background: #f7fbf3;
                        border: 3px solid #f7fbf3;                        
            padding: 10px 0; 
           /* box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); */
            z-index: 1000; 
        }
        #controls div {
            margin: 5px 0; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        button { 
            padding: 8px 8px; 
            margin: 0 5px; 
            cursor: pointer; 
            border: 2px solid #85ae5f; 
            background: #85ae5f; /*192332*/
                        box-shadow: 0 5px 5px rgba(0, 0, 0, 0.2);
            color: #fffbef; 
            font-size: 28px; 
            border-radius: 5px; 
        }
        #sentenceNumber { 
            width: 50px; 
            padding: 10px; 
            text-align: center; 
            border: 3px solid #85ae5f; /*041b31 68838B*/
            background: #f1cc76; 
            color: #000; 
            border-radius: 10px; 
            font-size: 16px; 
            -moz-appearance: textfield; 
        }
        #sentenceNumber::-webkit-inner-spin-button, 
        #sentenceNumber::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        #sentenceNumber:disabled { 
            background: #eee; 
        }
        .disabled { 
            cursor: not-allowed; 
            pointer-events: none; 
        }
        .active-mode { 
            border: 2px solid #fed16a; 
        }
        #indicator { 
            width: 95%;
                        max-width: 700px; 
            min-height: 50px; 
            margin: 10px auto; 
                        padding: 5px;
            border: 3px solid #fed16a; 
            background: #ffffe0; 
            border-radius: 10px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
        }
        #optionsContainer {
            width: 100%;
            max-width: 700px;
            margin: 10px auto;
        }
        .optionBtn {
            width: 95%; 
            max-width: 700px;
            padding: 10px;
            margin: 5px 0;
            border: 2px solid #ffffff;
            background: #ffffff; /*E6EDD9*/
            color: #000000;
                        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 30px;
            text-align: left;
            cursor: pointer;
            border-radius: 5px;
        }
        .optionBtn:hover {
            background: #D2E4C4;
        }
        .correct {
            background: #B7D7AA !important;
        }
        .wrong {
            background: #CE6D5E !important;
        }
        #score { 
            display: none; 
            width: 100%;
            max-width: 700px;
            margin: 10px auto; 
            color: #FF6820; 
            font-size: 30px; 
            text-align: center;
        }
        #wrongSentences { 
            display: none; 
            width: 95%; 
            max-width: 700px; 
            margin: 10px auto; 
            padding: 10px; 
            border: 2px solid #CE6D5E; 
            background: #FFF0F0; 
            color: #CE6D5E; 
            font-size: 30px; 
            text-align: left; 
            border-radius: 5px; 
        }
        #results { 
            display: none; 
            width: 95%;
            max-width: 700px;        
            margin: 10px auto; 
            padding: 10px; 
            border: 2px solid #734A2E; 
            background: #fffbef; 
            color: #000; 
            font-size: 30px; 
            text-align: left; 
            border-radius: 5px; 
            white-space: pre-line;
        }

        /* Media query cho thiết bị di động */
        @media (max-width: 768px) {
            body {
                padding-bottom: 200px; /* Giảm padding-bottom cho điện thoại */
            }
            #controls {
                padding: 5px 0; /* Giảm padding */
            }
            button {
                padding: 6px 6px; /* Giảm kích thước nút */
                font-size: 20px; /* Giảm kích thước chữ */
            }
            #sentenceNumber {
                width: 40px; /* Giảm chiều rộng */
                padding: 8px; /* Giảm padding */
                font-size: 14px; /* Giảm kích thước chữ */
            }
            .optionBtn {
                font-size: 20px; /* Giảm kích thước chữ cho đáp án */
                padding: 8px; /* Giảm padding */
            }
            #infoBox {
                font-size: clamp(30px, 4vw, 40px); /* Giảm kích thước chữ */
            }
            #contactBox, #instructionBox {
                font-size: clamp(14px, 2vw, 16px); /* Giảm kích thước chữ */
            }
            #indicator {
                min-height: 40px; /* Giảm chiều cao tối thiểu */
            }
            #results, #wrongSentences, #score {
                font-size: 24px; /* Giảm kích thước chữ */
                                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="infoBox">习得越南语<br>听力练习</div>
        <div id="contactBox">讲师-阮玉煌 | Weixin：XiDeYueNanYu</div>
        <div id="instructionBox">选择与播放内容相符的选项</div>
        <div id="indicator"></div>
        <div id="optionsContainer"></div>
        <div id="results"></div>
        <div id="score">0/0</div>
        <div id="wrongSentences"></div>
    </div>
    <div id="controls">
        <div>
            <button id="freeModeBtn" class="active-mode">自由模式</button>
            <button id="testModeBtn">作业模式</button>
        </div>
        <div>
            <button id="autoContinueBtn">自动继续</button>
            <button id="showHideBtn">显示-隐藏</button>
        </div>
        <div>
            <button id="prevBtn">◀</button>
            <input type="text" id="sentenceNumber" inputmode="numeric" pattern="[0-9]*">
            <button id="nextBtn">▶</button>
            <button id="replayBtn">再听一遍</button>
        </div>
    </div>
    <audio id="mainAudio" src="audio.mp3"></audio>
    <audio id="correctAudio" src="Dung.mp3"></audio>
    <audio id="wrongAudio" src="Sai.mp3"></audio>

    <script>
        const audio = document.getElementById('mainAudio');
        const correctAudio = document.getElementById('correctAudio');
        const wrongAudio = document.getElementById('wrongAudio');
        const indicator = document.getElementById('indicator');
        const sentenceNumber = document.getElementById('sentenceNumber');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const replayBtn = document.getElementById('replayBtn');
        const freeModeBtn = document.getElementById('freeModeBtn');
        const testModeBtn = document.getElementById('testModeBtn');
        const autoContinueBtn = document.getElementById('autoContinueBtn');
        const showHideBtn = document.getElementById('showHideBtn');
        const scoreDisplay = document.getElementById('score');
        const wrongSentencesDisplay = document.getElementById('wrongSentences');
        const optionsContainer = document.getElementById('optionsContainer');
        const resultsDisplay = document.getElementById('results');

        const buttons = [prevBtn, nextBtn, replayBtn, freeModeBtn, testModeBtn, autoContinueBtn, showHideBtn];


const sentences = [
    {
        "audioFile": "audio.mp3",
        "start": 0.170917,
        "end": 2.060917,
        "correctAnswer": "Quyển sách nằm trong ngăn bàn.",
        "translation": "书放在抽屉里。",
        "options": [
            "Quyển sách nằm trong ngăn bàn.",
            "Quyển sách nắm trong ngăn bàn.",
            "Quyển sách nằm trong ngân bàn.",
            "Quyển sách nằm trông ngăn bàn."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 2.670917,
        "end": 4.820917,
        "correctAnswer": "Con mèo đang ngủ trong hộp giấy.",
        "translation": "猫正在纸盒里睡觉。",
        "options": [
            "Con mèo đang ngủ trong hộp giấy.",
            "Con mèo đang ngũ trong hộp giấy.",
            "Con mèo đang ngủ trong hốp giấy.",
            "Con mèo đang ngủ trông hộp giảy."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 5.470917,
        "end": 7.510917,
        "correctAnswer": "Điện thoại để trong túi áo khoác.",
        "translation": "手机放在外套口袋里。",
        "options": [
            "Điện thoại để trong túi áo khoác.",
            "Điện thoại đễ trong túi áo khoác.",
            "Điện thoại để trong túi ao khoát.",
            "Điện thoại để trông túi áo khoác."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 8.200917,
        "end": 10.860917,
        "correctAnswer": "Tôi sẽ hoàn thành bài báo cáo trong hai ngày.",
        "translation": "我将在两天内完成报告。",
        "options": [
            "Tôi sẽ hoàn thành bài báo cáo trong hai ngày.",
            "Tôi sẽ hoàn thành bày báo cáo trong hai ngày.",
            "Tôi sẽ hoàn thành bài bão cáo trong hai ngày.",
            "Tôi sẽ hoàn thành bài báo cáo trong hai ngầy."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 11.560917,
        "end": 13.970917,
        "correctAnswer": "Anh ấy sống ở Hà Nội trong sáu tháng.",
        "translation": "他在河内住了六个月。",
        "options": [
            "Anh ấy sống ở Hà Nội trong sáu tháng.",
            "Anh ấy sống ở Hà Nội trong sáo tháng.",
            "Anh ấy sống ở Hà Nội trong sáu thảng.",
            "Anh ấy sống ở Hả Nội trong sáu tháng."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 14.680917,
        "end": 17.180917,
        "correctAnswer": "Cô ấy dự định đi du lịch trong tuần tới.",
        "translation": "她打算下周去旅行。",
        "options": [
            "Cô ấy dự định đi du lịch trong tuần tới.",
            "Cô ấy dự đinh đi du lịch trong tuần tới.",
            "Cô ấy dự định đi du lịc trong tuần tới.",
            "Cô ấy dự định đi du lịch trong tuấn tới."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 17.900917,
        "end": 19.910917,
        "correctAnswer": "Làm ơn lấy giúp tôi cái kéo.",
        "translation": "请帮我拿一下剪刀。",
        "options": [
            "Làm ơn lấy giúp tôi cái kéo.",
            "Làm ơn lấy giụp tôi cái kéo.",
            "Làm ơn lấy giúp tôi cái keo.",
            "Làm ơn lấy giúp tôi cái kèo."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 20.690917,
        "end": 22.620917,
        "correctAnswer": "Cậu mở giùm cửa sổ được không?",
        "translation": "你能帮我打开窗户吗？",
        "options": [
            "Cậu mở giùm cửa sổ được không?",
            "Cậu mở giùm cửa số được không?",
            "Cậu mỡ giùm cửa sổ được không?",
            "Cậu mở giùm cưa sổ được không?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 23.220917,
        "end": 25.300917,
        "correctAnswer": "Bạn gọi hộ tôi ly cà phê nhé.",
        "translation": "请帮我点一杯咖啡吧。",
        "options": [
            "Bạn gọi hộ tôi ly cà phê nhé.",
            "Bạn gọi hổ tôi ly cà phê nhé.",
            "Bạn gọi hộ tôi ly cà phe nhé.",
            "Bạn gỏi hộ tôi ly cà phê nhé."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 26.010917,
        "end": 28.080917,
        "correctAnswer": "Làm ơn nhắn lại với anh ấy giúp tôi.",
        "translation": "请帮我转告他一声。",
        "options": [
            "Làm ơn nhắn lại với anh ấy giúp tôi.",
            "Làm ơn nhắn lại vơi anh ấy giúp tôi.",
            "Làm ơn nhắn lạy với anh ấy giúp tôi.",
            "Làm ơn nhặn lạy với anh ấy giúp tôi."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 28.760917,
        "end": 30.540917,
        "correctAnswer": "Cầm giùm tôi cái túi này với.",
        "translation": "帮我拿一下这个包吧。",
        "options": [
            "Cầm giùm tôi cái túi này với.",
            "Cầm giùm tôi cái túy này với.",
            "Cẩm giùm tôi cái túi này với.",
            "Cầm giùm tôi cái túi nay với."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 31.110917,
        "end": 32.510917,
        "correctAnswer": "Đóng cửa giúp em nhé!",
        "translation": "帮我关一下门吧！",
        "options": [
            "Đóng cửa giúp em nhé!",
            "Đóng cửa giụp em nhé!",
            "Đóng cửa giúp êm nhé!",
            "Đống cửa giúp em nhé!"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 33.080917,
        "end": 35.060917,
        "correctAnswer": "Bạn in hộ tôi tài liệu này không?",
        "translation": "你能帮我打印这份文件吗？",
        "options": [
            "Bạn in hộ tôi tài liệu này không?",
            "Bạn in hổ tôi tài liệu này không?",
            "Bạn in hộ tôi tài liêu này không?",
            "Bạn in hộ tôi tài liệu nay không?"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 35.800917,
        "end": 37.970917,
        "correctAnswer": "Lau hộ cái bàn này hộ chị với.",
        "translation": "帮我擦一下这张桌子吧。",
        "options": [
            "Lau hộ cái bàn này hộ chị với.",
            "Lau hộ cái bàng này hộ chị với.",
            "Lau hổ cái bàn này hộ chị với.",
            "Lau hộ cái bàn này hổ chị với."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 38.770917,
        "end": 40.430917,
        "correctAnswer": "Chụp giúp mình tấm hình nha!",
        "translation": "帮我拍张照片吧！",
        "options": [
            "Chụp giúp mình tấm hình nha!",
            "Chụp giúp minh tấm hình nha!",
            "Chụp giụp mình tấm hình nha!",
            "Chụp giúp mình tấm hinh nha!"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 41.250917,
        "end": 43.390917,
        "correctAnswer": "Làm ơn kiểm tra giùm em thông tin này.",
        "translation": "请帮我检查一下这个信息。",
        "options": [
            "Làm ơn kiểm tra giùm em thông tin này.",
            "Làm ơn kiểm tra giùm em thong tin này.",
            "Làm ơn kiểm tra giùm êm thông tin này.",
            "Làm ơn kiểm tra giùm em thông tin nay."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 44.130917,
        "end": 45.780917,
        "correctAnswer": "Để tôi xách đồ giúp bạn.",
        "translation": "让我来帮你提东西吧。",
        "options": [
            "Để tôi xách đồ giúp bạn.",
            "Để tôi sách đồ giúp bạn.",
            "Để tôi xách đồ giụp bạn.",
            "Để tôi xách đô giúp bạn."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 46.310917,
        "end": 48.040917,
        "correctAnswer": "Để em làm việc này giúp anh.",
        "translation": "让我来帮你做这件事吧。",
        "options": [
            "Để em làm việc này giúp anh.",
            "Để em làm việt này giúp anh.",
            "Để em làm việc này giụp anh.",
            "Để em làm việc này giúp ạnh."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 48.630917,
        "end": 50.290917,
        "correctAnswer": "Để anh dọn bàn hộ em.",
        "translation": "让我来帮你收拾桌子吧。",
        "options": [
            "Để anh dọn bàn hộ em.",
            "Để anh dọn bàn hổ em.",
            "Để anh dọn bàng hộ em.",
            "Để anh don bàn hộ em."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 51.160917,
        "end": 52.910917,
        "correctAnswer": "Để chị nấu cơm giùm em.",
        "translation": "让我来帮你煮饭吧。",
        "options": [
            "Để chị nấu cơm giùm em.",
            "Để chị náu cơm giùm em.",
            "Để chị nấu cơm giụm em.",
            "Để chị nấu côm giùm em."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 53.710917,
        "end": 55.490917,
        "correctAnswer": "Để tôi đăng ký hộ anh ấy.",
        "translation": "让我替他报名。",
        "options": [
            "Để tôi đăng ký hộ anh ấy.",
            "Để tôi đăng kỷ hộ anh ấy.",
            "Để tôi đăng ký hổ anh ấy.",
            "Để tôi đăn ký hộ anh ấy."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 56.000917,
        "end": 57.520917,
        "correctAnswer": "Để tôi giải thích cho.",
        "translation": "让我来解释吧。",
        "options": [
            "Để tôi giải thích cho.",
            "Để tôi giãi thích cho.",
            "Để tôi giải thíc cho.",
            "Để tôi giải thiếc cho."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 58.000917,
        "end": 59.570917,
        "correctAnswer": "Để con rửa bát giúp mẹ.",
        "translation": "让我来帮妈妈洗碗。",
        "options": [
            "Để con rửa bát giúp mẹ.",
            "Để con rữa bát giúp mẹ.",
            "Để con rửa bát giụp mẹ.",
            "Để con rửa bát giúp mẽ."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 60.150917,
        "end": 61.730917,
        "correctAnswer": "Để tớ lái xe cho.",
        "translation": "让我来开车吧。",
        "options": [
            "Để tớ lái xe cho.",
            "Để tớ lại xe cho.",
            "Để tớ lái xẹ cho.",
            "Để tỡ lái xe cho."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 62.390917,
        "end": 64.130917,
        "correctAnswer": "Để mình lấy nước hộ cậu nhé.",
        "translation": "让我帮你倒水吧。",
        "options": [
            "Để mình lấy nước hộ cậu nhé.",
            "Để mình lây nước hộ cậu nhé.",
            "Để mình lấy nước hổ cậu nhé.",
            "Để mình lấy nước hộ cẩu nhé."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 64.810917,
        "end": 66.230917,
        "correctAnswer": "Để mình đi chợ cho.",
        "translation": "让我去买菜吧。",
        "options": [
            "Để mình đi chợ cho.",
            "Để mình đi chỡ cho.",
            "Để mình đi chợ chô.",
            "Để mỉnh đi chợ cho."
        ]
    }
];

        let currentIndex = 0;
        let isFreeMode = true;
        let correctCount = 0;
        let isPlaying = false;
        let correctSentences = new Set();
        let wrongSentences = new Set();
        let autoContinue = false;
        let showAnswer = false;
        let userAnswers = [];

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function init() {
            updateSentenceDisplay();
        }

        function updateSentenceDisplay() {
            sentenceNumber.value = currentIndex + 1;
            indicator.style.background = '#ffffe0';
            if (isFreeMode && showAnswer) {
                indicator.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #85ae5f;">${sentences[currentIndex].translation}</div>
                `;
            } else {
                indicator.innerHTML = '';
            }
            updateOptions();
            if (!isFreeMode) updateScore();
        }

        function updateOptions() {
            optionsContainer.innerHTML = '';
            const shuffledOptions = shuffleArray(sentences[currentIndex].options);
            shuffledOptions.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'optionBtn';
                btn.textContent = option;
                btn.onclick = () => checkAnswer(option);
                optionsContainer.appendChild(btn);
            });
        }

        function playCurrentSentence() {
            if (isPlaying) audio.pause();
            buttons.forEach(btn => btn.classList.add('disabled'));
            sentenceNumber.disabled = true;
            isPlaying = true;
            audio.src = sentences[currentIndex].audioFile;
            audio.currentTime = sentences[currentIndex].start;
            audio.play().catch(error => {
                console.error('Audio playback failed:', error);
                alert('Vui lòng nhấn nút “再听一遍” để phát âm thanh.');
                buttons.forEach(btn => btn.classList.remove('disabled'));
                sentenceNumber.disabled = false;
                isPlaying = false;
            });

            audio.ontimeupdate = () => {
                if (audio.currentTime >= sentences[currentIndex].end) {
                    audio.pause();
                    audio.ontimeupdate = null;
                    buttons.forEach(btn => btn.classList.remove('disabled'));
                    sentenceNumber.disabled = false;
                    isPlaying = false;
                }
            };
        }

        function moveSentence(direction) {
            currentIndex = (currentIndex + direction + sentences.length) % sentences.length;
            updateSentenceDisplay();
            playCurrentSentence();
        }

        function checkAnswer(selectedAnswer) {
            const correctAnswer = sentences[currentIndex].correctAnswer;
            const optionButtons = optionsContainer.getElementsByClassName('optionBtn');
            
            // Clear previous styles
            for (let btn of optionButtons) {
                btn.classList.remove('correct', 'wrong');
                btn.disabled = !isFreeMode; // Only disable buttons in Test Mode
            }

            // Find and style the selected button
            for (let btn of optionButtons) {
                if (btn.textContent === selectedAnswer) {
                    if (selectedAnswer === correctAnswer) {
                        indicator.style.background = '#B7D7AA';
                                                indicator.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #000000;">${sentences[currentIndex].translation}</div>
                `;
                        btn.classList.add('correct');
                        correctAudio.play().catch(error => {
                            console.error('Correct audio playback failed:', error);
                        });
                    } else {
                        indicator.style.background = '#CE6D5E';
                                                indicator.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #000000;">${sentences[currentIndex].translation}</div>
                `;
                        btn.classList.add('wrong');
                        wrongAudio.play().catch(error => {
                            console.error('Wrong audio playback failed:', error);
                        });
                    }
                }
            }

            if (!isFreeMode) {
                userAnswers[currentIndex] = selectedAnswer;
                if (selectedAnswer === correctAnswer && !correctSentences.has(currentIndex)) {
                    correctCount++;
                    correctSentences.add(currentIndex);
                    wrongSentences.delete(currentIndex);
                } else if (selectedAnswer !== correctAnswer && !correctSentences.has(currentIndex)) {
                    wrongSentences.add(currentIndex);
                }
                updateScore();

                // Auto-move to next sentence in Test Mode
                const audioToWait = (selectedAnswer === correctAnswer) ? correctAudio : wrongAudio;
                audioToWait.onended = () => {
                    if (userAnswers.length === sentences.length) {
                        showResults();
                    } else {
                        setTimeout(() => {
                            moveSentence(1);
                        }, 200);
                    }
                };
            } else if (isFreeMode && autoContinue && selectedAnswer === correctAnswer) {
                // Auto-move in Free Mode only if answer is correct and autoContinue is enabled
                correctAudio.onended = () => {
                    setTimeout(() => {
                        moveSentence(1);
                    }, 200);
                };
            } else {
                correctAudio.onended = null;
                wrongAudio.onended = null;
            }
        }

        function updateScore() {
            scoreDisplay.textContent = `${correctCount}/${sentences.length}`;
            scoreDisplay.style.display = 'block'; // Hiển thị score trong Test Mode
        }

        function showResults() {
            let resultText = `练习完成！\n正确答案数量：${correctCount}/${sentences.length}\n正确率：${((correctCount / sentences.length) * 100).toFixed(2)}%\n错误题目：`;
            wrongSentences.forEach(index => {
                resultText += `\n第${index + 1}题：\n你的选择：${userAnswers[index] || '未选择'}\n正确答案：${sentences[index].correctAnswer}\n`;
            });
            if (wrongSentences.size === 0) {
                resultText += '\n全部正确！';
            }
            resultsDisplay.textContent = resultText;
            resultsDisplay.style.display = 'block';
        }

        prevBtn.onclick = () => {
            moveSentence(-1);
        };

        nextBtn.onclick = () => {
            moveSentence(1);
        };

        replayBtn.onclick = () => {
            playCurrentSentence();
        };

        freeModeBtn.onclick = () => {
            isFreeMode = true;
            freeModeBtn.classList.add('active-mode');
            testModeBtn.classList.remove('active-mode');
            autoContinueBtn.disabled = false;
            autoContinueBtn.classList.remove('disabled');
            showHideBtn.disabled = false;
            showHideBtn.classList.remove('disabled');
            scoreDisplay.style.display = 'none';
            wrongSentencesDisplay.style.display = 'none';
            resultsDisplay.style.display = 'none';
            updateSentenceDisplay();
        };

        testModeBtn.onclick = () => {
            isFreeMode = false;
            testModeBtn.classList.add('active-mode');
            freeModeBtn.classList.remove('active-mode');
            autoContinueBtn.disabled = true;
            autoContinueBtn.classList.add('disabled');
            showHideBtn.disabled = true;
            showHideBtn.classList.add('disabled');
            showHideBtn.classList.remove('active-mode');
            showAnswer = false;
            scoreDisplay.style.display = 'block';
            currentIndex = 0;
            correctCount = 0;
            correctSentences.clear();
            wrongSentences.clear();
            userAnswers = [];
            for (let i = 0; i < sentences.length; i++) {
                wrongSentences.add(i);
            }
            updateSentenceDisplay();
        };

        autoContinueBtn.onclick = () => {
            if (isFreeMode) {
                autoContinue = !autoContinue;
                autoContinueBtn.classList.toggle('active-mode');
                if (!autoContinue) {
                    correctAudio.onended = null;
                }
            }
        };

        showHideBtn.onclick = () => {
            if (isFreeMode) {
                showAnswer = !showAnswer;
                showHideBtn.classList.toggle('active-mode');
                updateSentenceDisplay();
            }
        };

        sentenceNumber.onchange = () => {
            if (!isPlaying) {
                const num = parseInt(sentenceNumber.value) - 1;
                if (!isNaN(num) && num >= 0 && num < sentences.length) {
                    currentIndex = num;
                    updateSentenceDisplay();
                    playCurrentSentence();
                } else {
                    alert(`输入范围： 1 到 ${sentences.length}`);
                    updateSentenceDisplay();
                }
            }
        };

        sentenceNumber.onkeydown = (e) => {
            if (!isPlaying) {
                if (e.key === 'ArrowLeft') {
                    moveSentence(-1);
                }
                if (e.key === 'ArrowRight') {
                    moveSentence(1);
                }
            }
        };

        init();
    </script>
</body>
</html>
